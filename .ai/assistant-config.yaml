# Configuration to help AI assistants and Copilot understand this project
project:
  name: superpsx
  description: PSX emulator running natively on PS2 (EE/R5900) via MIPS→MIPS JIT recompiler
  root: .
  language: C99
  toolchain: ee-gcc (PS2 EE cross-compiler)
  build:
    - cmake -S . -B build
    - cmake --build build
  test:
    gte: |
      rm -f build/superpsx.ini && printf "gte_vu0 = 0\n" > build/superpsx.ini &&
      perl -e 'alarm 60; exec @ARGV' make -C build run GAMEARGS=tests/gte/test-all/test-all.exe 2>&1 |
      grep -E "Passed|Failed" | head -5;
      rm -f build/superpsx.ini && ln -s $(pwd)/superpsx.ini build/superpsx.ini
    cpu: |
      perl -e 'alarm 120; exec @ARGV' make -C build run GAMEARGS=tests/psxtest_cpu/psxtest_cpu.exe 2>&1 | grep -c "error"
    timers: |
      perl -e 'alarm 60; exec @ARGV' make -C build run GAMEARGS=tests/timers/timers.exe 2>&1 | tail -20
  expected_results:
    gte: "1150 passed, 0 failed"
    cpu: "227 (known deviations)"
  quick_run:
    - make -C build run GAMEARGS=tests/timers/timers.exe
    - make -C build run GAMEARGS=isos/CrashBandicoot/CrashBandicoot.cue
  artifacts:
    - build/superpsx.elf
  env:
    PSX_CPU_FREQ: 33868800
  important_paths:
    - src/dynarec_compile.c   # Block compiler, prologue/epilogue, DCE, branch handling
    - src/dynarec_emit.c      # Low-level emitters, pinned reg sync, C call trampolines
    - src/dynarec_insn.c      # Per-instruction emission (ALU, loads, stores, COP)
    - src/dynarec_memory.c    # Memory access emission (range checks, fast/cold paths)
    - src/dynarec_run.c       # Block dispatch loop, trampoline setup, hash table
    - src/dynarec_cache.c     # Block cache, SMC page tracking, direct block linking
    - src/dynarec.h           # Shared header: register defines, macros, types
    - include/superpsx.h      # Main emulator state (CPU struct, globals)
    - include/scheduler.h     # Event-based scheduler, CPU frequency constants
    - CMakeLists.txt
  cmake_flags:
    ENABLE_PSX_TLB: "OFF — TLB fast-path (experimental)"
    ENABLE_DYNAREC_STATS: "OFF — JIT execution statistics"
    ENABLE_SUBSYSTEM_PROFILER: "ON — Per-subsystem wall-clock profiler"
    HEADLESS: "OFF — Build without GPU (no-op stubs)"
  notes: |
    - 13 PSX registers are pinned to EE hardware registers (see dynarec.h).
    - Infrastructure regs: S0=cpu ptr, S1=RAM base, S2=cycles_left, S3=mask(0x1FFFFFFF).
    - Scratch regs: T0, T1, T2, AT (T0/T1 have scratch cache for non-pinned regs).
    - DYNAREC_PROLOGUE_WORDS = 29. Code blocks start at code_buffer[144+].
    - Use `next_vblank_cycle` global as the VBlank anchor for timer geometry.
    - CPU frequency constants are defined in `include/scheduler.h`.
    - macOS has no timeout/gtimeout; use perl -e 'alarm N; exec @ARGV' wrapper.
    - See docs/jit_optimization_roadmap.md for planned optimizations.
    - See .github/copilot-instructions.md for Copilot-specific rules.
